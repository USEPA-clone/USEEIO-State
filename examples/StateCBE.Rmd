---
title: Consumption-Based Greenhouse Gas Emissions Results for `r params$state` for `r min(params$years)`-`r max(params$years)`
date: '`r format(Sys.time(), "%B %d, %Y")`'
output:
  bookdown::html_document2:
    fig_caption: yes
params:
  model:
    label: "Model Type"
    value: "v1.1-GHG"
    input: select
    choices: ["v1.1-GHG","v1.1-GHGc"]
  years:
    label: "Model Year"
    value: [2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020]
    input: select
    multiple: TRUE
    choices: [2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020]
  state:
    label: "State"
    value: ""
    input: select
    multiple: FALSE
    choices: ["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL",
              "IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT",
              "NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI",
              "SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"]
---

```{r setup, include=FALSE}
source("../R/utils.R")
install_useeior()
source("../R/StateEEIOFigures.R")
source("../R/StateEEIOCalculations.R")
library(useeior)
library(knitr)

# Stop execution of Rmd if params not selected
if (params$state=="" || length(params$year) < 2)  {
  stop("You must select a state and at least two years.")
}

#Select model build parameters
state <- params$state
years <- params$years
spec <- params$model

#state <- "WA"
#years <- c(2012:2020)
#spec <- "v1.1-GHG"

focal_year <- 2019

indicator <- "Greenhouse Gases"

if (spec == "v1.1-GHG") {
  modelstub <- 'EEIOv1.1-GHG-'
} else if (spec == "v1.1-GHGc") {
  if(!state %in% c("VT", "NY", "ME")) {
    stop(paste0(state, " not available with a customized GHG Inventory, please use v1.1-GHG."))
  }
  modelstub <- 'EEIOv1.1-GHGc-'  
}

```

```{r load-models, echo=FALSE}

models <- list()
for(y in years) {
   modelname <- paste0(state, modelstub, substr(y,3,4))
   name_for_list <- paste0(state,"-",toString(y))
   file_path <- file.path("..","models",paste0(modelname,".rds"))
   if(!file.exists(file_path)) {
     stop("Please first build or download the models for the selected state and years.")
   }
   models[[name_for_list]] <- readRDS(file_path)
}


```

A consumption-based emissions inventory (CBEI) is an accounting method that can be applied to a region, including a state, that quantifies emissions associated with all goods and services consumed by a state, regardless of their origin.
This approach allows these regions to account for more complete emissions caused by the consumption of goods in their region.

This document presents summary consumption-based emission (CBE) results for **`r state`** for the years **`r paste0(min(years), "-", max(years))`**.
These results were generated using USEEIO State models along with state-specific territorial GHG inventories estimated by EPA.
Further details on the methods for calculating consumption based emissions and interpreting the results can be found in the associated EPA Report, [Consumption-Based Greenhouse Gas Inventories for Northeastern States](https://cfpub.epa.gov/si/si_public_record_Report.cfm?dirEntryId=352619&Lab=CESER).


# Total Consumption-Based Emissions

```{r calculate_results, include=FALSE, echo=FALSE}

cbe_all <- sapply(models,calculateStateCBE,simplify=TRUE,USE.NAMES=TRUE)
row.names(cbe_all) <- row.names(calculateStateCBE(models[[1]]))

cbe_agg_soi <- aggregateStateResultMatrix(models[[1]], cbe_all, region=state)
cbe_agg_rous <- aggregateStateResultMatrix(models[[1]], cbe_all, region='RoUS')
cbe_agg_row <- aggregateStateResultMatrix(models[[1]], cbe_all, region='RoW')

cbe_agg <-  cbe_agg_soi + cbe_agg_rous + cbe_agg_row

households_all <- sapply(models, calculateHouseholdShares, indicator=indicator, simplify=TRUE, USE.NAMES=TRUE)
rownames(households_all) <- rownames(calculateHouseholdShares(models[[1]], indicator))
#households_all <- readRDS("../models/households_all.RDS")

result_code_loc <- gsub(models[[1]]$specs$ModelRegionAcronyms[1], "SoI", row.names(cbe_all[[1]]))
cbe_all_total <- matrix(unlist(cbe_all), ncol=length(cbe_all), dimnames=list(result_code_loc,names(cbe_all))) 

cbe_all_totals <- data.frame(CBE=colSums(cbe_all))
cbe_all_wide_MMT <- convertStateResultFormatToStatebyYear(cbe_all_totals, value.var="CBE")/1E9

```


```{r cbe_total, echo=FALSE}

kable(cbe_all_wide_MMT, digits=1, caption = 'Consumption-based emissions in million metric tons.')

```

\\@ref(tab:cbe_total) shows the

(\#tab:cbe_total) tries another way to cross-reference

[@tab:cbe_total] tries another way to cross-reference

# Comparison to Territorial Inventory

Many U.S. states compile regular annual greenhouse gas inventories (GHGIs) that are used as a benchmark in measuring progress toward greenhouse gas (GHG) emissions reduction goals.
These territorial (also called sector-based) inventories typically cover GHG emissions occurring within the state’s borders.
They typically include emissions associated with transportation, electricity production, industry, land use and forestry, commercial and residential buildings, and waste disposal.
CBEs include emissions occurring upstream of the point of consumption; when those emissions occur out of state, they would not appear in the state’s territorial inventory.
The CBEI results are contrasted with the state territorial emissions in Figure \\@ref(fig:cbe_territorial). 

```{r cbe_territorial, echo=FALSE, fig.width=6.5, fig.height=4, fig.cap="Comparison of consumption-based and territorial GHG emissions." }
ghgi_all <- sapply(models, getStateGHGI, simplify=TRUE, USE.NAMES=TRUE)

# Compare CBE to Territorial for Focal state
terr <- t(as.matrix(colSums(ghgi_all, na.rm = TRUE)))
cbe <- t(as.matrix(colSums(cbe_agg, na.rm = TRUE)))
combined <- as.matrix(rbind(terr, cbe))
rownames(combined) <- c("Territorial", "CBE")
p <- lineChartFigure(combined / 10^9, ylabel="MMT CO2e")
p <- p +
  scale_y_continuous(limits = c(0, NA)) +
  theme(text = element_text(size=12))
p

```
# Consumption-Based Emissions Intensity

A CBE increase can be driven by an increase in the consumption of goods and services or in the embodied carbon intensity, measured in GHG emissions per dollar spent on goods and services, or by increases in both.
Changes in consumption as measured in current U.S. dollars, which are the dollar value for the year in which goods are consumed, can be influenced by the changing value of the dollar when inflation or deflation are present.
Changes in real consumption are better measured by using a constant dollar value across time to control for this effect.
To account for changes in population growth, CBE per person is shown in Figure \@ref(fig:per_person).

Figures in this section show a time series of these different intensities.

```{r per_dollar, fig.caption="Consumption-based emissions per dollar consumed by state residents.", echo=FALSE}
d <- sapply(models, calculateDemandByRegion, price_year=focal_year, USE.NAMES = TRUE)
d <- colSums(d)
per_d <- (cbe*1000)/d
rownames(per_d) <- "CBE per $ consumed"
per_d_fig <- lineChartFigure(per_d, "g CO2e per $ consumed")
per_d_fig <- per_d_fig + theme(text = element_text(size=12),
                                 legend.position="none")
per_d_fig
```


```{r per_person, echo=FALSE, fig.cap="CBE per state resident."}
pop <- load_state_population()
pop <- pop[which(pop$Year %in% years),]
pop_wide <- reformatStatebyYearLongtoWide(pop, value.var="Population")
pop_wide <- as.matrix(pop_wide[which(rownames(pop_wide) == state),])
per_p <- (cbe /1000) / pop_wide
rownames(per_p) <- "CBE / person"
per_person <- lineChartFigure(per_p, "tonnes CO2e per person")
per_person <- per_person + theme(text = element_text(size=12),
                                 legend.position="none")
per_person
```
# Consumption-Based Emissions By Category of Goods or Service Consumed and Region of Origin

\@ref(fig:cbe_results) shows the CBE of `r state` by aggregate sector and the region of origin of GHG emissions for year `r focal_year`.

```{r cbe_results, echo=FALSE, fig.cap="test caption cab_results. RoUS = Rest of US; RoW = Rest of World"}

#cbe_by_year_list <- c()
#for(y in years) {
col <- paste0(state, "-", focal_year)
cbe_agg_soi_year <- as.matrix(cbe_agg_soi[, col])
cbe_agg_rous_year <- as.matrix(cbe_agg_rous[, col])
cbe_agg_row_year <- as.matrix(cbe_agg_row[, col])

v <- c(RoUS='cbe_agg_rous_year', RoW='cbe_agg_row_year')
v[state] <- 'cbe_agg_soi_year' # Set state specific name for this vector
ghgs <- combineResults(v)
ghgs$Value <- ghgs$Value / 10^9
ghgs <- subset(ghgs, !(ghgs$Sector %in% c("Used", "Other")))

# Split Household Shares before developing figure
households <- as.data.frame(households_all[, col, drop=FALSE])
households <- cbind(newSector= rownames(households), households)
households$Sector <- "F010"
ghgs2 <- merge(ghgs, households, by = "Sector", all.x=TRUE)
idx <- !is.na(ghgs2$newSector)
ghgs2$Sector[idx] <- ghgs2$newSector[idx]
ghgs2$Value[idx] <- ghgs2$Value[idx] * ghgs2[idx, col]
ghgs <- ghgs2[c("ID", "Sector", "Value")]

p <- stackedBarChartResultFigure(ghgs, models[[col]])
p <- p + 
  xlab('Greenhouse Gases (million tonnes)') +
  labs(fill = 'Region') +
  ggtitle(col) +
  theme(axis.text.y = element_text(size = 7))
p
```


# Trade Emissions Balance
A trade emissions balance is another way of assessing emissions from a consumption-based perspective.
A trade balance in economics is typically defined as exports from a region minus the imports into the region, where a trade surplus indicates more goods and services leaving the region that coming in from outside the region.
Analogously, trade balance information can be used to derive a trade emissions balance for each region.
Emissions are exported from the SoI when they occur in the SoI but are associated with a commodity that is consumed outside the state, either in the RoUS or RoW.
Imported emissions are those occurring out of state but associated with a commodity consumed by the SoI.
Figure \@ref(fig:trade_balance) shows the trend balance of emissions for the time series.
A positive value of the balance represents net positive emissions from trade, meaning that a state's consumption results in more emissions than it makes to produce exports.


```{r trade_balance, echo=FALSE, fig.cap="Trade emissions trade balance", fig.width=6.5, fig.height=4, warning=FALSE}
cbe_trade_all <- sapply(models, calculateCBETradeBalance, simplify=FALSE, USE.NAMES=TRUE)
cbe_trade_all_df <- sapply(cbe_trade_all, matricizeandflip)
rownames(cbe_trade_all_df) <- c("Exports to RoUS", "Exports to RoW", "Imports from RoUS",
                                "Imports from RoW", "Balance")
cbe_trade_summary_df <- rbind(colSums(cbe_trade_all_df[c(1, 2),]),
                              colSums(cbe_trade_all_df[c(3, 4),]),
                              cbe_trade_all_df[c(5),])
rownames(cbe_trade_summary_df) <- c("Exports", "Imports", "Balance")
# Alternatively can chart "cbe_trade_all_df" to differentiate RoW and RoUS
trade_balance <- lineChartFigure(cbe_trade_summary_df / 10^9, "Greenhouse Gases (million tonnes)")
trade_balance <- trade_balance + theme(text = element_text(size=12))
trade_balance
```


