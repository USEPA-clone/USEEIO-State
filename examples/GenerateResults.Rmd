---
title: Generate and Graph results for a State EEIO Model"
output:
  md_document:
    variant: gfm
params:
  model:
    label: "Model Type"
    value: "v1.0"
    input: select
    choices: ["v1.0"] #, "v1.1-GHG"]
  year:
    label: "Model Year"
    value: 2012
    input: select
    multiple: FALSE
    choices: [2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020]
  state:
    label: "State"
    value: ""
    input: select
    choices: ["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL",
              "IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT",
              "NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI",
              "SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"]
---

```{r setup, include=FALSE}
source("../R/utils.R")
install_useeior()
source("../R/StateEEIOFigures.R")
source("../R/StateEEIOCalculations.R")
library(useeior)
library(reshape2)

# Stop execution of Rmd if params not selected
if (params$state=="") {
  stop("You must select a state and a year.")
}

## Select model build parameters
state <- params$state
year <- params$year
spec <- params$model

if (spec == "v1.0") {
  modelstub <- 'EEIOv1.0-s-'
} else if (spec == "v1.1-GHG") {
  modelstub <- 'EEIOv1.1-GHG-'
} else if (spec == "v1.1-GHGc") {
  modelstub <- 'EEIOv1.1-GHGc-'  
}

```

```{r load-model, echo=FALSE}
modelname <- paste0(state, modelstub, substr(year,3,4))
file_path <- download_model_RDS(modelname)
model <- readRDS(file_path) # Test that it loads correctly

```
```{r }
ghg_total <- calculateStateCBE(model)
ghg_domestic <- calculateStateCBE(model, domestic=TRUE)
ghg_RoW <- ghg_total - ghg_domestic

ghg_agg_dom <- aggregateStateResultMatrix(model, ghg_domestic, RoUS=FALSE)
ghg_agg_rous <- aggregateStateResultMatrix(model, ghg_domestic, RoUS=TRUE)
ghg_agg_row <- aggregateStateResultMatrix(model, ghg_RoW, RoUS=FALSE) + aggregateStateResultMatrix(model, ghg_RoW, RoUS=TRUE)

colSums(ghg_agg_dom + ghg_agg_rous + ghg_agg_row) == colSums(ghg_total)

```




```{r ghg_results, echo=FALSE, fig.width=9, fig.height=4}

ghgs <- combineResults(c(State = 'ghg_agg_dom', RoUS='ghg_agg_rous', ROW='ghg_agg_row'))
ghgs$Value <- ghgs$Value / 10^9
p <- stackedBarChartResultFigure(ghgs)
p <- p + 
  xlab('Greenhouse Gases (million tonnes)') +
  labs(fill = 'Region')
p

```
![GHG emissions, Final perspective.](`r knitr::fig_chunk('ghg_results', 'png')`){#fig:ghg_results}


```{r time_series_demand, echo=FALSE, fig.width=9, fig.height=4}

models <- list()
for(y in c(2012:2019)) {
   modelname <- paste0(state, modelstub, substr(y,3,4))
   name_for_list <- paste0(state,"-",toString(y))
   file_path <- download_model_RDS(modelname)
   models[[name_for_list]] <- readRDS(file_path)
}

d <- sapply(models, calculateDemandByType)
rownames(d) <- rownames(calculateDemandByType(models[[1]]))
lineChartFigure(d / 1000000000)

d <- sapply(models, calculateDemandByType, price_year=2019)
rownames(d) <- rownames(calculateDemandByType(models[[1]]))
p1 <- lineChartFigure(d / 1000000000)
p1 <- p1 + ylab("Billion $ (2019)")
p1

d <- sapply(models, calculateDemandByRegion, price_year=2019)
rownames(d) <- rownames(calculateDemandByRegion(models[[1]]))
p2 <- lineChartFigure(d / 1000000000)
p2 <- p2 + ylab("Billion $ (2019)")
p2

```



```{r ghg_time_series, echo=FALSE, fig.width=8, fig.height=6}
ghgs_all <- sapply(models, calculateStateCBE)
rownames(ghgs_all) <- rownames(calculateStateCBE(models[[1]]))
ghgs_all <- (aggregateStateResultMatrix(models[[1]], ghgs_all, RoUS=FALSE) +
               aggregateStateResultMatrix(models[[1]], ghgs_all, RoUS=TRUE))

p1 <- twoRegionTimeSeriesPlot(ghgs_all / 10^9, plottype = "bar")
p1 <- p1 + labs(y = "MMT CO2e")
p1

p2 <- twoRegionTimeSeriesPlot(ghgs_all/ 10^9, plottype = "line")
p2 <- p2 + labs(y = "MMT CO2e")
p2

```
```{r cbe_territorial}
ghgi_all <- sapply(models, getStateGHGI, simplify=TRUE, USE.NAMES=TRUE)

# Compare CBE to Territorial for Focal state
terr <- t(as.matrix(colSums(ghgi_all, na.rm = TRUE)))
cbe <- t(as.matrix(colSums(ghgs_all, na.rm = TRUE)))
combined <- as.matrix(rbind(terr, cbe))
rownames(combined) <- c("Territorial", "CBE")
p <- lineChartFigure(combined / 10^9)
p <- p + ylab("MMT CO2e") +
     scale_y_continuous(limits = c(0, NA))
p

```
