---
title: Generate and Graph results for a State EEIO Model"
output:
  md_document:
    variant: gfm
params:
  model:
    label: "Model Type"
    value: "v1.0"
    input: select
    choices: ["v1.0"] #, "v1.1-GHG"]
  year:
    label: "Model Year"
    value: 2012
    input: select
    multiple: FALSE
    choices: [2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020]
  state:
    label: "State"
    value: ""
    input: select
    choices: ["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL",
              "IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT",
              "NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI",
              "SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"]
---

```{r setup, include=FALSE}
source("../R/utils.R")
install_useeior()
source("../R/StateEEIOFigures.R")
source("../R/StateEEIOCalculations.R")
library(useeior)
library(reshape2)

# Stop execution of Rmd if params not selected
if (params$state=="") {
  stop("You must select a state and a year.")
}

## Select model build parameters
state <- params$state
year <- params$year
spec <- params$model

if (spec == "v1.0") {
  modelstub <- 'EEIOv1.0-s-'
} else if (spec == "v1.1-GHG") {
  modelstub <- 'EEIOv1.1-GHG-'
}

```

```{r load-model, echo=FALSE}
modelname <- paste0(state, modelstub,substr(year,3,4))
file_path <- download_model_RDS(modelname)
model <- readRDS(file_path) # Test that it loads correctly

```

```{r ghg_results, echo=FALSE, fig.width=9, fig.height=4}

df <- stackedBarChartResult(model, indicator="Greenhouse Gases", perspective="FINAL", scale=9)

stackedBarChartResultFigure(df, level="group", x_title="Greenhouse Gases (million tonnes)")
```
![GHG emissions, Final perspective.](`r knitr::fig_chunk('ghg_results', 'png')`){#fig:ghg_results}


```{r time_series_demand, echo=FALSE, fig.width=9, fig.height=4}
demand <- data.frame()
demand_by_source <- data.frame()
for (y in c(2012:2019)) {
  modelname <- paste0(state, modelstub,substr(y,3,4))
  file_path <- download_model_RDS(modelname)
  model <- readRDS(file_path)
  demands <- calculateDemandVectors(model, price_year = "2019")
  # ^^ change price_year to y to get current year price figures
  demand <- rbind(demand, demands$demand)
  demand_by_source <- rbind(demand_by_source, demands$demand_by_source)
}

p1 <- lineChartDemand(demand)
p1 <- p1 + ylab("Billion $ (2019)")
p1
p2 <- lineChartDemand(demand_by_source)
p2 <- p2 + ylab("Billion $ (2019)")
p2


```



```{r ghg_time_series, echo=FALSE, fig.width=8, fig.height=6}
results <- data.frame()

for (y in c(2012:2019)) {
  modelname <- paste0(state, modelstub,substr(y,3,4))
  file_path <- download_model_RDS(modelname)
  model <- readRDS(file_path)
  model_list <- list()
  model_list[[paste0("US-", state)]] <- model
  
  df <- prepareDFforFigure(model_list=model_list, matrix_name=NULL, perspective="FINAL",
                           indicator="Greenhouse Gases", sector_to_remove="", demand="Consumption",
                           combine_SoIRoUS=TRUE, household_emissions=FALSE)
  df$Year <- as.character(y)
  results <- rbind(results, df)
}

p1 <- twoRegionTimeSeriesPlot(results, plottype = "bar", legend_ncol = 2, scale=9)
p1 <- p1 + labs(y = "MMT CO2e")
p1

p2 <- twoRegionTimeSeriesPlot(results, plottype = "line", legend_ncol = 2, scale=9)
p2 <- p2 + labs(y = "MMT CO2e")
p2

```
