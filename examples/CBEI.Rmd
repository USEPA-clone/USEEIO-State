---
title: Consumption-Based Emissions Results Using a State EEIO Model"
output:
  md_document:
    variant: gfm
params:
  model:
    label: "Model Type"
    value: "v1.1"
    input: select
    choices: ["v1.1-GHG","v1.1-GHGc"]
  years:
    label: "Model Year"
    value: [2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019]
    input: select
    multiple: TRUE
    choices: [2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020]
  state:
    label: "State"
    value: ""
    input: select
    multiple: FALSE
    choices: ["CT","NH","ME","MA","NY","NJ","RI","VT"] #"AK","AZ","AR","CA","CO",,"DE","FL","GA","HI","ID","IL",
#"IN","IA","KS","KY","LA",,"MD","MI","MN","MS","MO","MT",
#"NE","NV","NM","NC","ND","OH","OK","OR","PA",
#"SC","SD","TN","TX","UT","VA","WA","WV","WI","WY"]
---

```{r setup, include=FALSE}
#source("../R/utils.R")
#install_useeior()
source("../R/StateEEIOFigures.R")
source("../R/StateEEIOCalculations.R")
#library(useeior)
devtools::load_all("../../useeior/")

# Stop execution of Rmd if params not selected
if (params$state=="") {
  stop("You must select a state and a year.")
}

## Select model build parameters
state <- params$state
years <- params$years
spec <- params$model

focal_year <- max(years)

if (spec == "v1.1-GHG") {
  modelstub <- 'EEIOv1.1-GHG-'
} else if (spec == "v1.1-GHGc") {
  modelstub <- 'EEIOv1.1-GHGc-'  
}

```

```{r load-models, echo=FALSE}

models <- list()
for(y in years) {
   modelname <- paste0(state, modelstub, substr(y,3,4))
   name_for_list <- paste0(state,"-",toString(y))
   file_path <- file.path("..","models",paste0(modelname,".rds"))#file_path <- download_model_RDS(modelname)
   models[[name_for_list]] <- readRDS(file_path)
}


#modelname <- paste0(state, modelstub, substr(year,3,4))
#file_path <- file.path("..","models",paste0(modelname,".rds"))
#model <- readRDS(file_path) # Test that it loads correctly

```

```{r }
model <- models[[paste0(state,"-",toString(focal_year))]]
ghg_total <- calculateStateCBE(model)
ghg_domestic <- calculateStateCBE(model, domestic=TRUE)
ghg_RoW <- ghg_total - ghg_domestic

ghg_agg_soi <- aggregateStateResultMatrix(model, ghg_domestic, RoUS=FALSE)
ghg_agg_rous <- aggregateStateResultMatrix(model, ghg_domestic, RoUS=TRUE)
ghg_agg_row <- aggregateStateResultMatrix(model, ghg_RoW, RoUS=FALSE) + aggregateStateResultMatrix(model, ghg_RoW, RoUS=TRUE)

```

```{r ghg_results, echo=FALSE, fig.width=9, fig.height=4}
v <- c(RoUS='ghg_agg_rous', RoW='ghg_agg_row')
v[state] <- 'ghg_agg_soi'
ghgs <- combineResults(v)
ghgs$Value <- ghgs$Value / 10^9
p <- stackedBarChartResultFigure(ghgs, model)
p <- p + 
  xlab('Greenhouse Gases (million tonnes)') +
  labs(fill = 'Region')
p

```
![GHG emissions, Final perspective.](`r knitr::fig_chunk('ghg_results', 'png')`){#fig:ghg_results}

## 
```{r time_series_demand, echo=FALSE, fig.width=9, fig.height=4}



d <- sapply(models, calculateDemandByType)
rownames(d) <- rownames(calculateDemandByType(models[[1]]))
lineChartFigure(d / 10^9)

d <- sapply(models, calculateDemandByType, price_year=2019)
rownames(d) <- rownames(calculateDemandByType(models[[1]]))
p1 <- lineChartFigure(d / 10^9)
p1 <- p1 + ylab("Billion $ (2019)")
p1

d <- sapply(models, calculateDemandByRegion, price_year=2019)
rownames(d) <- rownames(calculateDemandByRegion(models[[1]]))
p2 <- lineChartFigure(d / 10^9)
p2 <- p2 + ylab("Billion $ (2019)")
p2

```



```{r ghg_time_series, echo=FALSE, fig.width=8, fig.height=6}
ghgs_all <- sapply(models, calculateStateCBE)
rownames(ghgs_all) <- rownames(calculateStateCBE(models[[1]]))
ghgs_all <- (aggregateStateResultMatrix(models[[1]], ghgs_all, RoUS=FALSE) +
               aggregateStateResultMatrix(models[[1]], ghgs_all, RoUS=TRUE))

p1 <- twoRegionTimeSeriesPlot(ghgs_all / 10^9, plottype = "bar")
p1 <- p1 + labs(y = "MMT CO2e")
p1

p2 <- twoRegionTimeSeriesPlot(ghgs_all/ 10^9, plottype = "line")
p2 <- p2 + labs(y = "MMT CO2e")
p2

```

```{r cbe_territorial}
ghgi_all <- sapply(models, getStateGHGI, simplify=TRUE, USE.NAMES=TRUE)

# Compare CBE to Territorial for Focal state
terr <- t(as.matrix(colSums(ghgi_all, na.rm = TRUE)))
cbe <- t(as.matrix(colSums(ghgs_all, na.rm = TRUE)))
combined <- as.matrix(rbind(terr, cbe))
rownames(combined) <- c("Territorial", "CBE")
p <- lineChartFigure(combined / 10^9)
p <- p + ylab("MMT CO2e") +
     scale_y_continuous(limits = c(0, NA))
p

```
